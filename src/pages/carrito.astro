---
// src/pages/carrito.astro
import "../styles/global.css";
---

<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>Mi Carrito - Forge3D</title>
  </head>
  <body class="bg-gray-950 text-gray-100 font-sans min-h-screen">
    <nav
      class="fixed top-0 left-0 right-0 z-50 bg-gray-950/70 backdrop-blur-lg border-b border-white/5"
    >
      <div
        class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center"
      >
        <a
          href="/"
          class="text-cyan-400 hover:text-cyan-300 font-bold flex items-center gap-2 transition"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"><path d="m15 18-6-6 6-6"></path></svg
          >
          Seguir comprando
        </a>
        <h1 class="text-lg font-bold tracking-tight">Tu Compra</h1>
      </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 pt-28 pb-12">
      <div id="empty-cart" class="text-center py-24 hidden">
        <div
          class="inline-flex items-center justify-center w-24 h-24 rounded-full bg-gray-900 border border-gray-800 mb-6 text-gray-600"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="40"
            height="40"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            ><circle cx="8" cy="21" r="1"></circle><circle cx="19" cy="21" r="1"
            ></circle><path
              d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"
            ></path><line x1="2" x2="22" y1="2" y2="22"></line></svg
          >
        </div>
        <p class="text-xl text-gray-400 mb-2">Tu carrito está vacío.</p>
        <p class="text-sm text-gray-600 mb-8">
          Parece que aún no has elegido ninguna impresión.
        </p>
        <a
          href="/"
          class="inline-block bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white font-bold py-3 px-8 rounded-full transition shadow-lg shadow-cyan-900/20"
        >
          Explorar Catálogo
        </a>
      </div>

      <div id="cart-content" class="grid grid-cols-1 lg:grid-cols-3 gap-10">
        <div class="lg:col-span-2 space-y-4" id="items-list"></div>

        <div class="lg:col-span-1">
          <div
            class="bg-gray-900/50 backdrop-blur-sm p-8 rounded-2xl border border-white/10 sticky top-28"
          >
            <h2 class="text-xl font-bold mb-6 text-white">Resumen</h2>

            <div class="space-y-3 mb-6 border-b border-gray-800 pb-6">
              <div class="flex justify-between text-gray-400">
                <span>Subtotal</span>
                <span id="subtotal-price" class="text-white">$0</span>
              </div>
              <div class="flex justify-between text-gray-400">
                <span>Envío</span>
                <span
                  class="text-cyan-400 text-xs font-bold uppercase tracking-wide px-2 py-0.5 rounded bg-cyan-900/30"
                  >Por acordar</span
                >
              </div>
            </div>

            <div class="flex justify-between mb-8 items-end">
              <span class="text-gray-300 font-medium">Total Estimado</span>
              <span
                id="total-price"
                class="text-3xl font-black bg-gradient-to-r from-cyan-400 to-blue-500 text-transparent bg-clip-text"
                >$0</span
              >
            </div>

            <button
              id="btn-ventipay"
              class="w-full bg-[#1a1a1a] hover:bg-black text-white font-bold py-4 rounded-xl flex items-center justify-center gap-2 transition-all shadow-lg hover:shadow-gray-900/30 transform hover:scale-[1.02] border border-white/10"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                ><rect x="2" y="5" width="20" height="14" rx="2"></rect><line
                  x1="2"
                  y1="10"
                  x2="22"
                  y2="10"></line></svg
              >
              <span>Pagar con VentiPay</span>
            </button>

            <button
              id="btn-clean"
              class="mt-4 text-xs text-gray-500 hover:text-red-400 w-full text-center transition-colors"
            >
              Vaciar todo el carrito
            </button>
          </div>
        </div>
      </div>
    </main>

    <script>
      import { cartItems, removeProductFromCart } from "../lib/cartStore";

      const emptyMsg = document.getElementById("empty-cart");
      const cartContent = document.getElementById("cart-content");
      const itemsList = document.getElementById("items-list");
      const totalLabel = document.getElementById("total-price");
      const subtotalLabel = document.getElementById("subtotal-price");

      // 1. CAMBIO AQUÍ: Buscamos el botón de VentiPay, no el de WhatsApp
      const btnVentiPay = document.getElementById("btn-ventipay");
      const btnClean = document.getElementById("btn-clean");

      cartItems.subscribe((items) => {
        const products = Object.values(items);

        // Lógica de visualización (Vacío vs Lleno)
        if (products.length === 0) {
          if (emptyMsg) emptyMsg.classList.remove("hidden");
          if (cartContent) cartContent.classList.add("hidden");
          return;
        }

        if (emptyMsg) emptyMsg.classList.add("hidden");
        if (cartContent) cartContent.classList.remove("hidden");

        // Renderizar lista
        if (itemsList) {
          itemsList.innerHTML = products
            .map(
              (item) => `
                    <div class="bg-gray-900/50 p-4 rounded-2xl border border-white/5 flex gap-5 items-center relative group hover:border-white/10 transition-colors">
                        <div class="w-24 h-24 bg-gray-950 rounded-xl overflow-hidden flex-shrink-0 border border-white/5">
                            <img src="${item.image_url}" class="w-full h-full object-cover" />
                        </div>
                        
                        <div class="flex-1 min-w-0 py-1">
                            <h3 class="font-bold text-lg text-white truncate">${item.name}</h3>
                            <p class="text-cyan-400 font-mono font-medium">$${item.price.toLocaleString("es-CL")}</p>
                        </div>

                        <div class="flex flex-col items-end gap-1 mr-4">
                            <div class="bg-gray-800 rounded-lg px-3 py-1 text-sm font-bold border border-gray-700">
                                x${item.quantity}
                            </div>
                        </div>
                        
                        <button 
                            data-id="${item.id}"
                            class="btn-delete text-gray-600 hover:text-red-500 p-2 transition-colors absolute top-2 right-2"
                            title="Eliminar"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                        </button>
                    </div>
                `
            )
            .join("");
        }

        // Reactivar botones de borrar
        document.querySelectorAll(".btn-delete").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            const target = e.currentTarget as HTMLButtonElement;
            const idToDelete = target.getAttribute("data-id");
            if (idToDelete) removeProductFromCart(idToDelete);
          });
        });

        // Calcular Totales
        const total = products.reduce(
          (acc, item) => acc + item.price * item.quantity,
          0
        );
        const totalFmt = "$" + total.toLocaleString("es-CL");

        if (totalLabel) totalLabel.innerText = totalFmt;
        if (subtotalLabel) subtotalLabel.innerText = totalFmt;

        // 2. CAMBIO AQUÍ: Lógica de Pago con VentiPay
        if (btnVentiPay) {
          btnVentiPay.onclick = async () => {
            const originalText = btnVentiPay.innerHTML;
            btnVentiPay.innerHTML = "Conectando..."; // Feedback visual
            btnVentiPay.disabled = true;
            btnVentiPay.classList.add("opacity-70");

            try {
              // Llamamos a nuestra API
              const response = await fetch("/api/checkout", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ items: products }),
              });

              const data = await response.json();

              if (data.url) {
                // Si VentiPay responde bien, nos vamos a pagar
                window.location.href = data.url;
              } else {
                throw new Error(data.error || "Error desconocido");
              }
            } catch (error) {
              console.error(error);
              alert("Hubo un problema al iniciar el pago. Revisa la consola.");
              btnVentiPay.disabled = false;
              btnVentiPay.innerHTML = originalText;
              btnVentiPay.classList.remove("opacity-70");
            }
          };
        }
      });

      if (btnClean) {
        btnClean.onclick = () => {
          if (confirm("¿Seguro quieres vaciar el carrito?")) cartItems.set({});
        };
      }
    </script>
  </body>
</html>
