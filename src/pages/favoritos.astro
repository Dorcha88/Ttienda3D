---
// src/pages/favoritos.astro
import Layout from '../layouts/Layout.astro';
---

<Layout title="Mis Favoritos | Prinlab3D">
    <div class="min-h-screen bg-gray-50 dark:bg-slate-950 py-12 px-4 transition-colors duration-300">
        <div class="max-w-7xl mx-auto">
            
            <h1 class="text-3xl md:text-4xl font-extrabold text-slate-800 dark:text-white mb-8 text-center">
                Tus Favoritos ‚ù§Ô∏è
            </h1>

            <div id="fav-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
                </div>

            <div id="empty-msg" class="hidden text-center py-20">
                <div class="text-6xl mb-4">üíî</div>
                <h3 class="text-xl font-bold text-gray-800 dark:text-white">A√∫n no tienes favoritos</h3>
                <a href="/#catalogo" class="text-pink-500 hover:underline mt-2 inline-block">Ir al cat√°logo</a>
            </div>

        </div>
    </div>

    <script>
        import { favoriteItems, toggleFavorite } from "../lib/favoritesStore";
        import { addProductToCart } from "../lib/cartStore";

        const grid = document.getElementById('fav-grid');
        const emptyMsg = document.getElementById('empty-msg');

        // Suscribirse para renderizar reactivamente
        favoriteItems.subscribe(items => {
            const products = Object.values(items);

            if (products.length === 0) {
                grid.innerHTML = '';
                emptyMsg.classList.remove('hidden');
            } else {
                emptyMsg.classList.add('hidden');
                grid.innerHTML = products.map(p => `
                    <article class="bg-white dark:bg-slate-900 rounded-2xl overflow-hidden border border-gray-100 dark:border-slate-800 shadow-sm hover:shadow-md transition">
                        <div class="h-48 w-full overflow-hidden p-4 flex items-center justify-center relative bg-white dark:bg-slate-800">
                            <img src="${p.image_url}" class="w-full h-full object-contain" />
                            <button class="remove-fav absolute top-2 right-2 text-red-500 hover:scale-110 transition bg-white/80 dark:bg-slate-900/80 rounded-full p-1.5" data-id="${p.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                            </button>
                        </div>
                        <div class="p-4">
                            <h3 class="font-bold text-gray-800 dark:text-white line-clamp-1 mb-1">${p.name}</h3>
                            <p class="text-blue-600 dark:text-blue-400 font-bold mb-3">$${Number(p.price).toLocaleString('es-CL')}</p>
                            <button class="add-to-cart w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg text-sm font-bold transition"
                                data-id="${p.id}" data-name="${p.name}" data-price="${p.price}" data-image="${p.image_url}">
                                Agregar al Carrito
                            </button>
                        </div>
                    </article>
                `).join('');

                // Eventos Borrar
                grid.querySelectorAll('.remove-fav').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const id = btn.getAttribute('data-id');
                        // Creamos un objeto dummy solo con el ID para borrarlo
                        toggleFavorite({ id }); 
                    });
                });

                // Eventos Agregar al Carrito
                grid.querySelectorAll('.add-to-cart').forEach(btn => {
                    btn.addEventListener('click', () => {
                        addProductToCart({
                            id: btn.getAttribute('data-id'),
                            name: btn.getAttribute('data-name'),
                            price: Number(btn.getAttribute('data-price')),
                            image_url: btn.getAttribute('data-image'),
                            quantity: 1
                        });
                        if(window.toggleCart) window.toggleCart();
                    });
                });
            }
        });
    </script>
</Layout>