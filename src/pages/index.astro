---
export const prerender = false;
import Layout from '../layouts/Layout.astro';
import { supabase } from "../lib/supabase";

// 1. TRAER PRODUCTOS DE SUPABASE
let productsDB = [];
let uniqueMaterials = [];

const { data, error } = await supabase
  .from('products')
  .select('*')
  .order('created_at', { ascending: false });

if (data) {
  productsDB = data;
  // Extraer materiales √∫nicos para el filtro
  uniqueMaterials = [...new Set(data.map(p => p.material).filter(m => m))]; 
}

if (error) {
  console.error("Error cargando productos:", error.message);
}

// 2. L√ìGICA DE ROLES
const { cookies } = Astro;
const accessToken = cookies.get("sb-access-token")?.value;
const refreshToken = cookies.get("sb-refresh-token")?.value;
let isAdmin = false;

if (accessToken && refreshToken) {
  const { data: { session } } = await supabase.auth.setSession({
    access_token: accessToken,
    refresh_token: refreshToken,
  });

  if (session) {
    const { data: profile } = await supabase.from('profiles').select('role').eq('id', session.user.id).single();
    isAdmin = profile?.role === 'admin';
  }
}
---

<Layout title="Cat√°logo | Prinlab3D">

<header class="relative pt-10 pb-12 px-4 text-center overflow-hidden bg-gradient-to-br from-pink-50 to-blue-50">
    <div class="relative max-w-5xl mx-auto">
        <h1 class="text-4xl md:text-6xl font-extrabold mb-6 tracking-tight text-gray-900 leading-tight">
    Impresiones 3D de Alta Calidad en 
    
    <span class="block pt-4 pb-2 leading-normal text-transparent bg-clip-text bg-gradient-to-r from-pink-500 to-blue-600">
        Regi√≥n de √ëuble
    </span>
</h1>
        <p class="text-gray-600 text-lg max-w-2xl mx-auto">
            Explora nuestra colecci√≥n de figuras y  accesorios
        </p>
    </div>
</header>


    <main id="catalogo" class="max-w-7xl mx-auto px-4 sm:px-6 py-12 bg-gray-50 min-h-screen">
        
        <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 mb-8 sticky top-24 z-30">
            <div class="flex flex-col md:flex-row gap-4 justify-between items-center">
                
                <div class="relative w-full md:w-1/3">
                    <input type="text" id="searchInput" placeholder="üîç Buscar personaje, producto..." class="w-full pl-10 pr-4 py-2.5 rounded-xl border border-gray-200 focus:border-pink-500 focus:ring-2 focus:ring-pink-100 outline-none transition" />
                    <svg class="absolute left-3 top-3 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </div>

                <div class="flex flex-wrap gap-3 w-full md:w-auto">
                    <select id="materialFilter" class="px-4 py-2.5 rounded-xl border border-gray-200 bg-white text-gray-700 focus:border-blue-500 outline-none cursor-pointer">
                        <option value="">Todo Material</option>
                        {uniqueMaterials.map(mat => (
                            <option value={mat}>{mat}</option>
                        ))}
                    </select>

                    <select id="sortFilter" class="px-4 py-2.5 rounded-xl border border-gray-200 bg-white text-gray-700 focus:border-blue-500 outline-none cursor-pointer">
                        <option value="newest">‚ú® M√°s Nuevos</option>
                        <option value="price-asc">üí≤ Precio: Menor a Mayor</option>
                        <option value="price-desc">üí∞ Precio: Mayor a Menor</option>
                        <option value="name-asc">üî§ Nombre: A-Z</option>
                    </select>
                </div>
            </div>
            
            <div class="mt-3 text-xs text-gray-400 font-medium px-1 flex justify-between">
                <span>Mostrando <span id="resultCount" class="text-gray-800 font-bold">{productsDB.length}</span> productos</span>
                <span id="pageInfo" class="text-pink-600 font-bold"></span>
            </div>
        </div>

        <div id="productsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8 min-h-[400px]">
            </div>

        <div id="hiddenCards" class="hidden">
            {productsDB.map((product) => (
                <article class="product-card group relative bg-white rounded-2xl overflow-hidden border border-gray-100 hover:border-pink-200 transition-all duration-300 hover:shadow-xl flex flex-col h-full"
                    data-name={product.name.toLowerCase()}
                    data-price={product.price}
                    data-material={product.material || ""}
                    data-date={product.created_at}
                >
                    <div class="h-64 w-full overflow-hidden bg-white p-4 flex items-center justify-center relative">
                        <img src={product.image_url} alt={product.name} class="w-full h-full object-contain group-hover:scale-110 transition duration-500" loading="lazy" />
                        <div class="absolute top-3 right-3 bg-white/90 backdrop-blur text-pink-600 font-bold px-3 py-1 rounded-full text-sm shadow-md border border-pink-100">
                            ${product.price.toLocaleString('es-CL')}
                        </div>
                        {product.material && (
                            <div class="absolute bottom-3 left-3 bg-gray-100/90 backdrop-blur text-gray-600 text-xs font-bold px-2 py-1 rounded-lg border border-gray-200">
                                {product.material}
                            </div>
                        )}
                    </div>

                    <div class="p-6 flex flex-col flex-1">
                        <h3 class="font-bold text-lg mb-2 text-gray-800 line-clamp-1">{product.name}</h3>
                        <p class="text-gray-500 text-sm mb-4 line-clamp-2 flex-1">{product.description || "Sin descripci√≥n."}</p>
                        
                        <button 
                            class="add-to-cart-btn w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white font-bold py-2.5 rounded-xl hover:from-blue-600 hover:to-purple-700 transition shadow-md active:scale-95 flex items-center justify-center gap-2"
                            data-id={product.id}
                            data-name={product.name}
                            data-price={product.price}
                            data-image={product.image_url}
                        >
                            <span>Agregar</span>
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>
                        </button>
                    </div>
                </article>
            ))}
        </div>
        
        <div id="noResults" class="hidden text-center py-20">
            <div class="text-6xl mb-4">üîç</div>
            <h3 class="text-xl font-bold text-gray-800">No encontramos productos</h3>
            <p class="text-gray-500">Intenta con otro nombre o cambia los filtros.</p>
        </div>

        <div id="paginationControls" class="flex justify-center items-center gap-2 mt-12">
            </div>

    </main>

 
    <script>
    import { addProductToCart } from "../lib/cartStore";

    // CONFIGURACI√ìN PAGINACI√ìN
    const ITEMS_PER_PAGE = 12; 
    let currentPage = 1;
    let currentFilteredCards = []; 

    // ELEMENTOS DOM
    const searchInput = document.getElementById('searchInput');
    const materialFilter = document.getElementById('materialFilter');
    const sortFilter = document.getElementById('sortFilter');
    const productsGrid = document.getElementById('productsGrid');
    const hiddenCardsContainer = document.getElementById('hiddenCards');
    const resultCount = document.getElementById('resultCount');
    const noResults = document.getElementById('noResults');
    const paginationControls = document.getElementById('paginationControls');
    const pageInfo = document.getElementById('pageInfo');

    const allCards = Array.from(hiddenCardsContainer.children);

    // FUNCI√ìN PRINCIPAL: FILTRAR Y ORDENAR
    function filterProducts() {
        const query = searchInput.value.toLowerCase();
        const material = materialFilter.value;
        const sort = sortFilter.value;

        // 1. Filtrar
        currentFilteredCards = allCards.filter(card => {
            const name = card.getAttribute('data-name');
            const mat = card.getAttribute('data-material');
            const matchesSearch = name.includes(query);
            const matchesMaterial = material === "" || mat === material;
            return matchesSearch && matchesMaterial;
        });

        // 2. Ordenar
        currentFilteredCards.sort((a, b) => {
            const priceA = Number(a.getAttribute('data-price'));
            const priceB = Number(b.getAttribute('data-price'));
            const nameA = a.getAttribute('data-name');
            const nameB = b.getAttribute('data-name');
            const dateA = new Date(a.getAttribute('data-date')).getTime();
            const dateB = new Date(b.getAttribute('data-date')).getTime();

            if (sort === 'price-asc') return priceA - priceB;
            if (sort === 'price-desc') return priceB - priceA;
            if (sort === 'name-asc') return nameA.localeCompare(nameB);
            if (sort === 'newest') return dateB - dateA;
            return 0;
        });

        // 3. Resetear y Renderizar (SIN SCROLL)
        currentPage = 1;
        renderPage(false); // <--- AQU√ç EST√Å EL CAMBIO: false para no hacer scroll al filtrar
        resultCount.innerText = currentFilteredCards.length;
    }

    // RENDERIZAR P√ÅGINA ACTUAL
    // Aceptamos un par√°metro 'shouldScroll' que por defecto es falso
    function renderPage(shouldScroll = false) {
        productsGrid.innerHTML = "";
        paginationControls.innerHTML = "";
        
        if (currentFilteredCards.length === 0) {
            noResults.classList.remove('hidden');
            pageInfo.innerText = "";
            return;
        } else {
            noResults.classList.add('hidden');
        }

        const start = (currentPage - 1) * ITEMS_PER_PAGE;
        const end = start + ITEMS_PER_PAGE;
        const pageItems = currentFilteredCards.slice(start, end);

        pageItems.forEach(card => {
            const clone = card.cloneNode(true);
            productsGrid.appendChild(clone);
        });

        const totalPages = Math.ceil(currentFilteredCards.length / ITEMS_PER_PAGE);
        pageInfo.innerText = `P√°gina ${currentPage} de ${totalPages}`;

        renderPaginationControls(totalPages);
        attachCartEvents(); 
        
        // SOLO HACEMOS SCROLL SI SE PIDE EXPL√çCITAMENTE (Al cambiar de p√°gina)
        if (shouldScroll === true) {
            productsGrid.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }

    // GENERAR BOTONES DE PAGINACI√ìN
    function renderPaginationControls(totalPages) {
        if (totalPages <= 1) return;

        // Bot√≥n Anterior
        const prevBtn = createPageButton('‚Üê', () => {
            if (currentPage > 1) { 
                currentPage--; 
                renderPage(true); // <--- AQU√ç S√ç QUEREMOS SCROLL
            }
        }, currentPage === 1);
        paginationControls.appendChild(prevBtn);

        // N√∫meros
        let startPage = Math.max(1, currentPage - 2);
        let endPage = Math.min(totalPages, startPage + 4);
        
        if (endPage - startPage < 4) {
            startPage = Math.max(1, endPage - 4);
        }

        for (let i = startPage; i <= endPage; i++) {
            const btn = createPageButton(i, () => {
                currentPage = i;
                renderPage(true); // <--- AQU√ç S√ç QUEREMOS SCROLL
            }, false, i === currentPage);
            paginationControls.appendChild(btn);
        }

        // Bot√≥n Siguiente
        const nextBtn = createPageButton('‚Üí', () => {
            if (currentPage < totalPages) { 
                currentPage++; 
                renderPage(true); // <--- AQU√ç S√ç QUEREMOS SCROLL
            }
        }, currentPage === totalPages);
        paginationControls.appendChild(nextBtn);
    }

    function createPageButton(text, onClick, disabled = false, active = false) {
        const btn = document.createElement('button');
        btn.innerText = text;
        btn.disabled = disabled;
        btn.onclick = onClick;
        
        let classes = "w-10 h-10 rounded-full font-bold transition flex items-center justify-center ";
        
        if (active) {
            classes += "bg-pink-500 text-white shadow-md transform scale-110";
        } else if (disabled) {
            classes += "bg-gray-100 text-gray-300 cursor-not-allowed";
        } else {
            classes += "bg-white text-gray-600 border border-gray-200 hover:bg-pink-50 hover:text-pink-500 hover:border-pink-200";
        }
        
        btn.className = classes;
        return btn;
    }

    function attachCartEvents() {
        productsGrid.querySelectorAll('.add-to-cart-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const t = e.currentTarget;
                addProductToCart({
                    id: t.getAttribute('data-id'),
                    name: t.getAttribute('data-name'),
                    price: Number(t.getAttribute('data-price') || 0),
                    image_url: t.getAttribute('data-image') || '',
                    quantity: 1
                });
                if(window.toggleCart) window.toggleCart();
            });
        });
    }

    // EVENT LISTENERS
    searchInput.addEventListener('input', filterProducts);
    materialFilter.addEventListener('change', filterProducts);
    sortFilter.addEventListener('change', filterProducts);

    // INICIALIZACI√ìN
    filterProducts(); 

</script>

</Layout>