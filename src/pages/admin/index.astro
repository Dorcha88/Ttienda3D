---
export const prerender = false;
import "../../styles/global.css";
import { supabase } from "../../lib/supabase";

// 1. SEGURIDAD
const { cookies, redirect } = Astro;
const accessToken = cookies.get("sb-access-token")?.value;
const refreshToken = cookies.get("sb-refresh-token")?.value;

if (!accessToken || !refreshToken) return redirect("/login");

const { data: { session }, error } = await supabase.auth.setSession({
  access_token: accessToken,
  refresh_token: refreshToken,
});

if (!session) return redirect("/login");

const { data: profile } = await supabase.from('profiles').select('role').eq('id', session.user.id).single();
if (profile?.role !== 'admin') return redirect("/");

// 2. OBTENER DATOS (Productos y Categor√≠as Oficiales)
let products = [];
let officialCategories = [];

// Hacemos las dos peticiones a la vez
const [productsRes, categoriesRes] = await Promise.all([
    supabase.from('products').select('*').order('created_at', { ascending: false }),
    supabase.from('categories').select('name').order('name', { ascending: true })
]);

// Procesar Productos
if (productsRes.data) {
    products = productsRes.data;
}

// Procesar Categor√≠as (Ahora usamos la tabla oficial)
if (categoriesRes.data) {
    officialCategories = categoriesRes.data.map(c => c.name);
}
---

<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>Admin Dashboard - Prinlab3D</title>
    <meta name="viewport" content="width=device-width" />
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
  </head>
  <body class="bg-gray-50 text-gray-800 font-sans min-h-screen">
    
    <nav class="bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center shadow-sm sticky top-0 z-30">
      <div class="flex items-center gap-3">
          <div class="h-10 w-10 bg-gradient-to-tr from-pink-500 to-blue-500 rounded-lg flex items-center justify-center font-bold text-white text-sm shadow">ADM</div>
          <h1 class="text-xl font-bold text-gray-800 tracking-tight">Panel de Control</h1>
      </div>
      <div class="flex gap-4">
          <a href="/" class="text-sm font-bold text-gray-500 hover:text-pink-600 transition flex items-center gap-2 bg-gray-100 px-4 py-2 rounded-full hover:bg-pink-50">Ver Tienda ‚Üó</a>
      </div>
    </nav>

    <main class="max-w-7xl mx-auto p-6 grid grid-cols-1 lg:grid-cols-3 gap-8">
      
      <section class="lg:col-span-1">
        <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-6 sticky top-24">
          <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
            <span class="text-2xl">‚ú®</span> Agregar Nuevo
          </h2>
          
          <form id="create-form" class="flex flex-col gap-5">
            <div>
              <label class="block text-xs font-bold text-gray-400 uppercase mb-2 tracking-wider">Nombre</label>
              <input type="text" id="new-name" required class="w-full bg-gray-50 border-2 border-gray-200 rounded-xl p-3 text-gray-800 focus:border-pink-400 outline-none transition"/>
            </div>
            
            <div>
              <label class="block text-xs font-bold text-gray-400 uppercase mb-2 tracking-wider">Categor√≠a</label>
              <select id="new-category" required class="w-full bg-gray-50 border-2 border-gray-200 rounded-xl p-3 text-gray-800 focus:border-pink-400 outline-none transition cursor-pointer">
                  <option value="" disabled selected>Selecciona una opci√≥n...</option>
                  {officialCategories.map(cat => <option value={cat}>{cat}</option>)}
              </select>
            </div>

            <div>
              <label class="block text-xs font-bold text-gray-400 uppercase mb-2 tracking-wider">Precio ($CLP)</label>
              <input type="number" id="new-price" required class="w-full bg-gray-50 border-2 border-gray-200 rounded-xl p-3 text-gray-800 focus:border-pink-400 outline-none transition"/>
            </div>

            <div>
              <label class="block text-xs font-bold text-gray-400 uppercase mb-2 tracking-wider">Imagen</label>
              <input type="file" id="new-image" accept="image/*" required class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-bold file:bg-pink-50 file:text-pink-600 hover:file:bg-pink-100 cursor-pointer"/>
            </div>

            <div>
              <label class="block text-xs font-bold text-gray-400 uppercase mb-2 tracking-wider">Descripci√≥n</label>
              <textarea id="new-desc" rows="3" class="w-full bg-gray-50 border-2 border-gray-200 rounded-xl p-3 text-gray-800 focus:border-pink-400 outline-none transition resize-none"></textarea>
            </div>

            <div class="flex items-center gap-3 p-2 bg-gray-50 rounded-xl border border-gray-100">
                <input type="checkbox" id="new-featured" class="w-5 h-5 text-pink-500 rounded focus:ring-pink-500 border-gray-300" />
                <label for="new-featured" class="text-sm font-bold text-gray-600 cursor-pointer select-none">‚≠ê Destacar en Portada</label>
            </div>

            <button type="submit" id="btn-create" class="bg-gradient-to-r from-pink-500 to-blue-500 hover:from-pink-600 hover:to-blue-600 text-white font-bold py-3 rounded-xl mt-2 transition shadow-md transform active:scale-95">
              Publicar Producto
            </button>
            <p id="create-msg" class="text-center text-sm mt-2 hidden font-bold"></p>
          </form>
        </div>
      </section>

      <section class="lg:col-span-2">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold text-gray-800">Inventario ({products?.length})</h2>
        </div>
        
        <div class="space-y-4">
          {products?.map((product) => (
            <div class="bg-white p-4 rounded-2xl flex flex-col sm:flex-row gap-5 items-center border border-gray-100 shadow-sm hover:shadow-md transition group relative">
              
              {product.is_featured && (
                  <div class="absolute top-2 right-2 text-xl" title="Producto Destacado">‚≠ê</div>
              )}

              <div class="h-24 w-24 bg-gray-50 rounded-xl overflow-hidden border border-gray-200 flex-shrink-0 relative">
                  <img src={product.image_url} alt={product.name} class="w-full h-full object-contain p-1"/>
              </div>
              
              <div class="flex-1 min-w-0 text-center sm:text-left">
                <h3 class="font-bold text-gray-800 text-lg truncate">{product.name}</h3>
                <div class="flex flex-wrap items-center justify-center sm:justify-start gap-2 mt-1">
                    <span class="text-pink-600 font-bold bg-pink-50 px-3 py-1 rounded-full text-sm border border-pink-100">${product.price.toLocaleString('es-CL')}</span>
                    <span class="text-gray-500 text-xs bg-gray-100 px-2 py-1 rounded border">{product.category || 'Sin Cat.'}</span>
                </div>
                <p class="text-xs text-gray-400 mt-2 truncate max-w-xs mx-auto sm:mx-0">{product.description}</p>
              </div>

              <div class="flex gap-2">
                <button class="btn-edit text-blue-400 hover:text-blue-600 p-2 rounded-lg hover:bg-blue-50 transition" data-product={JSON.stringify(product)} title="Editar">‚úèÔ∏è</button>
                <button class="btn-delete text-gray-400 hover:text-red-500 p-2 rounded-lg hover:bg-red-50 transition" data-id={product.id} title="Eliminar">üóëÔ∏è</button>
              </div>
            </div>
          ))}
        </div>
      </section>

    </main>

    <div id="edit-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 relative animate-fade-in">
            <button id="close-modal" class="absolute top-4 right-4 text-gray-400 hover:text-red-500 font-bold text-xl">‚úï</button>
            <h2 class="text-xl font-bold text-gray-800 mb-4">Editar Producto</h2>
            
            <form id="edit-form" class="flex flex-col gap-4">
                <input type="hidden" id="edit-id" />
                <input type="hidden" id="edit-old-image-url" /> 

                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">Nombre</label>
                    <input type="text" id="edit-name" class="w-full border rounded-lg p-2 outline-none focus:border-blue-500"/>
                </div>
                
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">Categor√≠a</label>
                    <select id="edit-category" class="w-full border rounded-lg p-2 outline-none focus:border-blue-500 cursor-pointer">
                        <option value="" disabled>Selecciona...</option>
                        {officialCategories.map(c => <option value={c}>{c}</option>)}
                    </select>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">Precio</label>
                    <input type="number" id="edit-price" class="w-full border rounded-lg p-2 outline-none focus:border-blue-500"/>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">Descripci√≥n</label>
                    <textarea id="edit-desc" rows="3" class="w-full border rounded-lg p-2 outline-none focus:border-blue-500"></textarea>
                </div>
                
                <div class="flex items-center gap-3 p-2 bg-gray-50 rounded-lg border border-gray-200">
                    <input type="checkbox" id="edit-featured" class="w-5 h-5 text-blue-600 rounded" />
                    <label for="edit-featured" class="text-sm font-bold text-gray-600 cursor-pointer select-none">‚≠ê Producto Destacado</label>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">Cambiar Imagen (Opcional)</label>
                    <input type="file" id="edit-image" accept="image/*" class="text-sm"/>
                </div>

                <button type="submit" id="btn-update" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 rounded-xl mt-2 shadow-lg">Guardar Cambios</button>
            </form>
        </div>
    </div>

    <div id="session-data" data-access={accessToken} data-refresh={refreshToken} class="hidden"></div>

    <script>
      import { supabase } from "../../lib/supabase";

      const sessionElement = document.getElementById('session-data');
      const accessToken = sessionElement?.dataset.access;
      const refreshToken = sessionElement?.dataset.refresh;
      if (accessToken && refreshToken) {
          await supabase.auth.setSession({ access_token: accessToken, refresh_token: refreshToken });
      }

      // === CREAR ===
      const createForm = document.getElementById('create-form');
      const btnCreate = document.getElementById('btn-create');
      const msgCreate = document.getElementById('create-msg');

      createForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        btnCreate.disabled = true; btnCreate.innerText = "Subiendo...";
        
        try {
            const name = document.getElementById('new-name').value;
            const price = document.getElementById('new-price').value;
            const desc = document.getElementById('new-desc').value;
            const category = document.getElementById('new-category').value;
            const isFeatured = document.getElementById('new-featured').checked;
            const file = document.getElementById('new-image').files[0];

            if (!file) throw new Error("Falta imagen");

            const fileName = `${Date.now()}-${file.name.replace(/\s+/g, '-')}`;
            const { error: upErr } = await supabase.storage.from('products').upload(fileName, file);
            if (upErr) throw upErr;

            const { data: { publicUrl } } = supabase.storage.from('products').getPublicUrl(fileName);

            const { error: dbErr } = await supabase.from('products').insert({
                name, price: parseFloat(price), description: desc, image_url: publicUrl,
                category, is_featured: isFeatured
            });
            if (dbErr) throw dbErr;

            window.location.reload();

        } catch (err) {
            alert("Error: " + err.message);
            btnCreate.disabled = false; btnCreate.innerText = "Publicar Producto";
        }
      });

      // === ELIMINAR ===
      document.querySelectorAll('.btn-delete').forEach(btn => {
          btn.addEventListener('click', async (e) => {
              if(!confirm("¬øEst√°s seguro de eliminar este producto?")) return;
              const id = e.currentTarget.dataset.id;
              const { error } = await supabase.from('products').delete().eq('id', id);
              if(error) alert("Error al borrar: " + error.message);
              else window.location.reload();
          });
      });

      // === EDITAR ===
      const modal = document.getElementById('edit-modal');
      const editForm = document.getElementById('edit-form');
      const btnUpdate = document.getElementById('btn-update');

      document.querySelectorAll('.btn-edit').forEach(btn => {
          btn.addEventListener('click', (e) => {
              const p = JSON.parse(e.currentTarget.dataset.product);
              document.getElementById('edit-id').value = p.id;
              document.getElementById('edit-name').value = p.name;
              document.getElementById('edit-price').value = p.price;
              document.getElementById('edit-desc').value = p.description || '';
              
              // Aqu√≠ el select buscar√° autom√°ticamente la opci√≥n que coincida con p.category
              document.getElementById('edit-category').value = p.category || '';
              
              document.getElementById('edit-featured').checked = p.is_featured || false;
              document.getElementById('edit-old-image-url').value = p.image_url;
              modal.classList.remove('hidden');
          });
      });

      document.getElementById('close-modal').addEventListener('click', () => modal.classList.add('hidden'));

      editForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          btnUpdate.disabled = true; btnUpdate.innerText = "Guardando...";

          try {
              const id = document.getElementById('edit-id').value;
              const name = document.getElementById('edit-name').value;
              const price = document.getElementById('edit-price').value;
              const desc = document.getElementById('edit-desc').value;
              const category = document.getElementById('edit-category').value;
              const isFeatured = document.getElementById('edit-featured').checked;
              const file = document.getElementById('edit-image').files[0];
              let imageUrl = document.getElementById('edit-old-image-url').value;

              if (file) {
                  const fileName = `${Date.now()}-edit-${file.name.replace(/\s+/g, '-')}`;
                  const { error: upErr } = await supabase.storage.from('products').upload(fileName, file);
                  if (upErr) throw upErr;
                  const { data } = supabase.storage.from('products').getPublicUrl(fileName);
                  imageUrl = data.publicUrl;
              }

              const { error: updateErr } = await supabase.from('products').update({
                  name, price: parseFloat(price), description: desc, category, is_featured: isFeatured, image_url: imageUrl
              }).eq('id', id);

              if (updateErr) throw updateErr;
              window.location.reload();

          } catch (err) {
              alert("Error al editar: " + err.message);
              btnUpdate.disabled = false; btnUpdate.innerText = "Guardar Cambios";
          }
      });
    </script>
  </body>
</html>