---
// src/layouts/Layout.astro
import "../styles/global.css";
import { supabase } from "../lib/supabase";

const { title = "Prinlab3D" } = Astro.props;

// --- LÃ“GICA DE AUTENTICACIÃ“N Y ROLES (Se ejecuta en todas las pÃ¡ginas) ---
const { cookies } = Astro;
const accessToken = cookies.get("sb-access-token")?.value;
const refreshToken = cookies.get("sb-refresh-token")?.value;
let isAdmin = false;

if (accessToken && refreshToken) {
  const { data: { session } } = await supabase.auth.setSession({
    access_token: accessToken,
    refresh_token: refreshToken,
  });

  if (session) {
    const { data: profile } = await supabase.from('profiles').select('role').eq('id', session.user.id).single();
    isAdmin = profile?.role === 'admin';
  }
}
---

<html lang="es" class="scroll-smooth">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{title}</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
    <style>
        /* Estilos globales */
        #cart-items-container::-webkit-scrollbar { width: 5px; }
        #cart-items-container::-webkit-scrollbar-thumb { background: #ec4899; border-radius: 10px; }
        .cart-sidebar {
            position: fixed; top: 0; right: 0; height: 100%; width: 400px; max-width: 100%;
            background-color: #ffffff; box-shadow: -5px 0 25px rgba(0,0,0,0.1);
            transform: translateX(100%); transition: transform 0.3s ease-in-out;
            z-index: 100; display: flex; flex-direction: column; border-left: 1px solid #f3f4f6;
        }
        .cart-open { transform: translateX(0) !important; }
        .cart-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.3); backdrop-filter: blur(2px);
            z-index: 90; display: none;
        }
        .cart-overlay.active { display: block; }
    </style>
    <slot name="head" />
</head>
<body class="bg-gray-50 text-gray-800 font-sans min-h-screen antialiased pt-24">

    <nav class="fixed top-0 left-0 right-0 z-50 bg-white/90 backdrop-blur-lg border-b border-gray-200 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 py-4 flex justify-between items-center">
            <a href="/" class="text-2xl font-black tracking-tight flex items-center gap-2 group">
                <span class="bg-gradient-to-r from-pink-500 to-blue-600 text-transparent bg-clip-text hover:opacity-80 transition-all">Prinlab3D</span>
            </a>
            <div class="flex gap-4 items-center">
                <a href="/nosotros" class="text-sm font-bold text-gray-500 hover:text-pink-500 transition">Nosotros</a>
                <a href="/#catalogo" class="text-sm font-bold text-gray-500 hover:text-blue-500 transition">Productos</a>
                {isAdmin && <a href="/admin" class="text-xs font-bold text-white bg-pink-500 px-3 py-1.5 rounded-full">Admin</a>}
                <button onclick="toggleCart()" class="relative group bg-white border-2 border-blue-400 text-blue-500 hover:bg-blue-50 p-2 rounded-full transition shadow-md">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>
                    <span id="cart-count-badge" class="absolute -top-2 -right-2 bg-pink-500 text-white text-xs font-bold w-5 h-5 flex items-center justify-center rounded-full shadow-sm">0</span>
                </button>
            </div>
        </div>
    </nav>

    <slot />

    <footer class="bg-white border-t border-gray-200 py-8 text-center text-gray-500 text-sm">
        <p>Â© {new Date().getFullYear()} Prinlab3D. Impreso con pasiÃ³n.</p>
    </footer>

    <div id="cart-overlay" class="cart-overlay" onclick="toggleCart()"></div>
    <div id="cart-sidebar" class="cart-sidebar">
        <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-gradient-to-r from-pink-50 to-white">
            <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2"><span class="text-pink-500">ðŸ›’</span> Tu Pedido</h2>
            <button onclick="toggleCart()" class="text-gray-400 hover:text-red-500 text-2xl font-bold transition px-2">âœ•</button>
        </div>
        <div id="cart-items-container" class="cart-items flex-1 overflow-y-auto p-6 space-y-4 bg-white"></div>
        <div class="p-6 border-t border-gray-100 bg-gray-50 shadow-[0_-5px_20px_rgba(0,0,0,0.05)]">
            <div class="flex justify-between items-end mb-6">
                <span class="text-gray-500 font-medium">Total:</span>
                <span id="cart-total" class="text-3xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-pink-500 to-blue-600">$0</span>
            </div>
            <div class="space-y-3">
                <button id="btn-ventipay" class="w-full bg-gray-900 hover:bg-black text-white py-4 rounded-xl font-bold shadow-lg flex justify-center items-center gap-3 transition transform hover:scale-[1.02]">Pagar con VentiPay</button>
                <button id="btn-whatsapp" class="w-full bg-green-500 hover:bg-green-600 text-white py-4 rounded-xl font-bold shadow-lg transition transform hover:scale-[1.02] flex justify-center items-center gap-2">Pedir por WhatsApp</button>
                <button onclick="limpiarCarrito()" class="w-full text-center text-xs text-gray-400 hover:text-red-500 underline mt-2 transition">Vaciar todo</button>
            </div>
        </div>
    </div>


    <script>
    import { cartItems, removeProductFromCart } from "../lib/cartStore";

    // 1. LÃ³gica para abrir/cerrar el carrito
    window.toggleCart = () => {
        const sidebar = document.getElementById('cart-sidebar');
        const overlay = document.getElementById('cart-overlay');
        if (sidebar && overlay) {
            sidebar.classList.toggle('cart-open');
            overlay.classList.toggle('active');
        }
    }

    // 2. LÃ³gica para vaciar el carrito
    window.limpiarCarrito = () => { 
        if(confirm("Â¿EstÃ¡s seguro de vaciar el carrito?")) {
            cartItems.set({}); 
        }
    };

    // 3. Referencias al DOM (Elementos visuales)
    const container = document.getElementById('cart-items-container');
    const totalEl = document.getElementById('cart-total');
    const countEl = document.getElementById('cart-count-badge');

    // 4. SUSCRIPCIÃ“N: AquÃ­ ocurre la magia. Cada vez que el carrito cambia, esto se ejecuta.
    cartItems.subscribe(items => {
        const products = Object.values(items);
        
        // Calcular totales
        const total = products.reduce((acc, i) => acc + (Number(i.price) * Number(i.quantity)), 0);
        const totalCount = products.reduce((acc, i) => acc + i.quantity, 0);

        // Actualizar textos de precio y cantidad
        if(countEl) countEl.innerText = totalCount;
        if(totalEl) totalEl.innerText = `$${total.toLocaleString('es-CL')}`;

        // Dibujar los productos en la lista
        if (container) {
            if (products.length === 0) {
                container.innerHTML = `
                    <div class="h-full flex flex-col justify-center items-center text-gray-400">
                        <span class="text-5xl mb-3">ðŸ›’</span>
                        <p>Tu carrito estÃ¡ vacÃ­o</p>
                    </div>`;
            } else {
                container.innerHTML = products.map(item => `
                    <div class="flex gap-4 bg-white p-3 rounded-xl border border-gray-100 shadow-sm items-center transition hover:border-pink-200">
                        <div class="w-16 h-16 bg-white rounded-lg overflow-hidden border border-gray-100 flex-shrink-0">
                            <img src="${item.image_url}" class="w-full h-full object-contain" alt="${item.name}" />
                        </div>
                        
                        <div class="flex-1 min-w-0">
                            <h4 class="font-bold text-sm text-gray-800 line-clamp-1">${item.name}</h4>
                            <p class="text-blue-600 text-xs font-bold mt-1">$${Number(item.price).toLocaleString('es-CL')}</p>
                        </div>

                        <div class="flex flex-col items-end gap-2">
                            <span class="bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded font-bold">x${item.quantity}</span>
                            <button class="text-red-400 hover:text-red-600 text-xs font-bold remove-btn p-1 transition" data-id="${item.id}">
                                Borrar
                            </button>
                        </div>
                    </div>
                `).join('');

                // Reactivar los botones de "Borrar" (porque acabamos de crear el HTML nuevo)
                document.querySelectorAll('.remove-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.getAttribute('data-id');
                        removeProductFromCart(id);
                    });
                });
            }
        }
    });

    // 5. BotÃ³n Pagar con VentiPay
    const btnVenti = document.getElementById('btn-ventipay');
    if(btnVenti) {
        btnVenti.onclick = async () => {
            const items = Object.values(cartItems.get());
            if (items.length === 0) return alert("Tu carrito estÃ¡ vacÃ­o.");
            
            btnVenti.innerText = "Conectando..."; 
            btnVenti.disabled = true;
            
            try {
                const res = await fetch('/api/checkout', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ items }) 
                });
                const data = await res.json();
                
                if(data.url) {
                    window.location.href = data.url;
                } else {
                    alert("Hubo un error al crear el pago.");
                }
            } catch(e) { 
                console.error(e);
                alert("Error de conexiÃ³n con el servidor."); 
            } finally { 
                btnVenti.innerHTML = `<span>Pagar con VentiPay</span>`; 
                btnVenti.disabled = false; 
            }
        };
    }

    // 6. BotÃ³n Pedir por WhatsApp
    const btnWsp = document.getElementById('btn-whatsapp');
    if(btnWsp) {
        btnWsp.onclick = () => {
            const items = Object.values(cartItems.get());
            if (items.length === 0) return alert("Tu carrito estÃ¡ vacÃ­o.");
            
            let msg = "Hola Prinlab3D! ðŸ‘‹ Me gustarÃ­a hacer este pedido:\n\n";
            items.forEach(p => { 
                msg += `â€¢ ${p.quantity}x ${p.name} - $${(p.price * p.quantity).toLocaleString('es-CL')}\n`; 
            });
            
            const total = items.reduce((acc, i) => acc + (Number(i.price) * Number(i.quantity)), 0);
            msg += `\nðŸ’° *Total a pagar: $${total.toLocaleString('es-CL')}*`;
            msg += `\n\nQuedo atento, gracias!`;

            window.open("https://wa.me/56921955584?text=" + encodeURIComponent(msg), "_blank");
        }
    }
</script>

</body>
</html>